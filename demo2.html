<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
    <meta name="format-detection" content="telephone=no"/>
    <title>AMR decode/encode tests</title>
</head>

<body>
<h2>解码 amr 文件、播放</h2>
<p id="sample-amr">
    <button id="sample-amr-load">加载、解码</button>
    <button id="sample-amr-play">播放</button>
    <a href="res/yuan.amr">yuan.amr</a>
</p>
<p>
    来个本地文件: <input type="file" id="amr-file" accept=".amr">
</p>
<script src="lib/amrnb.js" defer></script>
<script>
    (function () {
        function E(selector) {
            return document.querySelector(selector);
        }

        var sample;
        E('#sample-amr-load').onclick = function() {
            fetchBlob(E('#sample-amr > a').href, function(blob) {
                readBlob(blob, function (array) {
                    sample = AMR.decode(array);
                    alert('Loaded');
                })
            });
        };

        E('#sample-amr-play').onclick = function () {
            if (!sample) {
                alert('请先加载解码');
            }
            playPcm(sample);
        };

        E('#amr-file').onchange = function() {
            playAmrBlob(this.files[0]);
        };

        var AudioContext = window.AudioContext || window.webkitAudioContext || window.mozAudioContext;
        var gAudioContext = new AudioContext();

        function getAudioContext() {
            if (!gAudioContext) {
                gAudioContext = new AudioContext();
            }
            return gAudioContext;
        }

        function fetchBlob(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.responseType = 'blob';
            xhr.onload = function() {
                callback(this.response);
            };
            xhr.onerror = function() {
                alert('Failed to fetch ' + url);
            };
            xhr.send();
        }

        function readBlob(blob, callback) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = new Uint8Array(e.target.result);
                callback(data);
            };
            reader.readAsArrayBuffer(blob);
        }

        function playAmrBlob(blob, callback) {
            readBlob(blob, function(data) {
                playAmrArray(data);
            });
        }

        function playAmrArray(array) {
            var samples = AMR.decode(array);
            if (!samples) {
                alert('Failed to decode!');
                return;
            }
            playPcm(samples);
        }

        function playPcm(samples) {
            var ctx = getAudioContext();
            var src = ctx.createBufferSource();
            var buffer;
            var newSamples = samples;
            try {
                buffer = ctx['createBuffer'](1, samples.length, 8000);
                alert('Sample Rate 8000 ok');
            } catch (e) {
                alert('catch! Sample Rate 8000 error, converse to 24000');
            }
            try {
                newSamples = new Float32Array(samples.length * 3);
                for (var i = 0; i < samples.length; i ++) {
                    newSamples[i * 3] = samples[i];
                    newSamples[i * 3 + 1] = samples[i];
                    newSamples[i * 3 + 2] = samples[i];
                }
                alert('converse to 24000 ok');
                buffer = ctx['createBuffer'](1, newSamples.length, 24000);
                alert('Sample Rate 24000 ok');
            } catch (e) {
                alert('catch! Sample Rate 24000 error');
            }
            try {
                if (buffer.copyToChannel) {
                    buffer.copyToChannel(newSamples, 0, 0)
                } else {
                    var channelBuffer = buffer.getChannelData(0);
                    channelBuffer.set(newSamples);
                }

                src.buffer = buffer;
                src.connect(ctx.destination);
                src.start();
            } catch (e) {
                alert(JSON.stringify(e));
            }

        }

    })();
</script>
</body>
</html>
